angular.module("fluro.video",["fluro.config","fluro.util","youtube-embed"]),angular.module("fluro.video").directive("fluroVideo",function($compile,Fluro){return{restrict:"E",replace:!0,template:'<div class="fluro-video video-{{model.assetType}}"></div>',controller:"FluroVideoController",scope:{model:"=ngModel",ngParams:"&"},link:function($scope,$element){$scope.$watch("model",function(){$scope.params=$scope.ngParams(),$scope.params||($scope.params={controls:0,autoplay:0,modestbranding:1,playsinline:1,showinfo:0,theme:"light",byline:0,portrait:0,title:0});var template;switch($element.empty(),$scope.model.assetType){case"youtube":template='<div class="embed-responsive embed-responsive-16by9"><youtube-video class="embed-responsive-item" video-url="model.external.youtube" player-vars="params"/></div>';break;case"vimeo":template='<div class="embed-responsive embed-responsive-16by9"><vimeo-video class="embed-responsive-item" video-url="model.external.vimeo" player-vars="params"/></div>';break;case"upload":$scope.playUrl=Fluro.apiURL+"/get/"+$scope.model._id,template='<div class="embed-responsive embed-responsive-16by9"><video class="embed-responsive-item" controls><source ng-src="{{playUrl | trustfluro}}" type="{{model.mimetype}}"></video></div>'}if(template){var cTemplate=$compile(template)($scope);$element.append(cTemplate)}})}}}).filter("trustfluro",["$sce",function($sce){return function(val){return $sce.trustAsResourceUrl(val)}}]).controller("FluroVideoController",function(){}).service("VideoTools",function($http){var controller={},cache={};return controller.getVideoThumbnail=function(item){if(item&&item._id){if(cache[item._id])return cache[item._id];switch(item.assetType){case"youtube":var details=controller.parseVideoURL(item.external.youtube);cache[item._id]="https://img.youtube.com/vi/"+details.id+"/mqdefault.jpg";break;case"vimeo":var id=controller.getVimeoID(item.external.vimeo);$http.get("https://vimeo.com/api/v2/video/"+id+".json",{withCredentials:!1}).then(function(res){"200"==String(res.status)&&res.data&&res.data[0]&&res.data[0]&&res.data[0].thumbnail_small&&(cache[item._id]=res.data[0].thumbnail_small)});break;case"upload":return}return cache[item._id]}},controller.getVimeoID=function(url){var reg=/https?:\/\/(?:www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/,match=url.match(reg);return match?match[3]:void 0},controller.parseVideoURL=function(url){function contains(str,substr){return str.indexOf(substr)>-1}function getParm(url,base){var re=new RegExp("(\\?|&)"+base+"\\=([^&]*)(&|$)"),matches=url.match(re);return matches?matches[2]:""}var matches,retVal={};if(-1!=url.indexOf("youtube.com/watch"))retVal.provider="youtube",retVal.id=getParm(url,"v");else if(matches=url.match(/vimeo.com\/(\d+)/))retVal.provider="vimeo",retVal.id=matches[1];else{var youtubeRegexp=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com\S*[^\w\s-])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,YoutubeID=url.replace(youtubeRegexp,"$1");if(contains(YoutubeID,";")){var pieces=YoutubeID.split(";");if(contains(pieces[1],"%")){var uriComponent=decodeURIComponent(YoutubeID.split(";")[1]);YoutubeID=("http://youtube.com"+uriComponent).replace(youtubeRegexp,"$1")}else YoutubeID=pieces[0]}else contains(YoutubeID,"#")&&(YoutubeID=YoutubeID.split("#")[0]);retVal.provider="youtube",retVal.id=YoutubeID}return retVal},controller}).directive("videoThumbnail",function(){return{restrict:"E",replace:!0,scope:{model:"=ngModel"},template:'<span><img ng-src="{{thumbnail.url}}"/></span>',controller:function($scope,$http,VideoTools){$scope.thumbnail={url:""},$scope.$watch(function(){return VideoTools.getVideoThumbnail($scope.model)},function(url){console.log("TEST URL",url),url&&($scope.thumbnail.url=url)})}}}),angular.module("fluro.video").service("VimeoEmbedSettings",function($http){var controller={};return controller.getVideoInformation=function(vimeoID){return $http.get("http://vimeo.com/api/v2/video/"+vimeoID+".output")},controller}).directive("vimeoVideo",function($compile,VimeoEmbedSettings){return{restrict:"E",scope:{videoId:"=",videoUrl:"=",playerVars:"="},link:function($scope,$element){function getVimeoID(url){var reg=/https?:\/\/(?:www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/,match=url.match(reg);return match?match[3]:void 0}$scope.getVideoInformation=function(){return $scope.videoId?VimeoEmbedSettings.getVideoInformation($scope.videoId):void 0},$scope.$watch("videoId + videoUrl + playerVars",function(){var VideoID;$scope.videoId?VideoID=$scope.videoId:$scope.videoUrl&&(VideoID=getVimeoID($scope.videoUrl));var params="";if($scope.playerVars)for(var key in $scope.playerVars)params+="&"+key+"="+$scope.playerVars[key];$scope.vimeoEmbedURL="//player.vimeo.com/video/"+VideoID+"?player_id="+VideoID+params});var template='<iframe ng-src="{{vimeoEmbedURL | trustVimeo}}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',cTemplate=$compile(template)($scope);$element.replaceWith(cTemplate)}}}).filter("trustVimeo",["$sce",function($sce){return function(val){return $sce.trustAsResourceUrl(val)}}]);