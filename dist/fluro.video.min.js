angular.module("fluro.video",["fluro.config","fluro.util","youtube-embed"]),angular.module("fluro.video").directive("fluroVideo",["$compile","Fluro",function($compile,Fluro){return{restrict:"E",replace:!0,template:'<div class="fluro-video video-{{model.assetType}}"></div>',controller:"FluroVideoController",scope:{model:"=ngModel",ngParams:"&"},link:function($scope,$element,$attrs){$scope.$watch("model",function(){$scope.params=$scope.ngParams(),$scope.params||($scope.params={controls:0,autoplay:0,modestbranding:1,playsinline:1,showinfo:0,theme:"light",byline:0,portrait:0,title:0});var template;switch($element.empty(),$scope.model.assetType){case"youtube":template='<div class="embed-responsive embed-responsive-16by9"><youtube-video class="embed-responsive-item" video-url="model.external.youtube" player-vars="params"/></div>';break;case"embed":template='<div class="embed-responsive embed-responsive-16by9">'+$scope.model.external.embed+"</div>";break;case"vimeo":template='<div class="embed-responsive embed-responsive-16by9"><vimeo-video class="embed-responsive-item" video-url="model.external.vimeo" player-vars="params"/></div>';break;case"upload":$scope.playUrl=Fluro.apiURL+"/get/"+$scope.model._id,template='<div class="embed-responsive embed-responsive-16by9"><video class="embed-responsive-item" controls><source ng-src="{{playUrl | trustfluro}}" type="{{model.mimetype}}"></video></div>'}if(template){var cTemplate=$compile(template)($scope);$element.append(cTemplate)}})}}}]),angular.module("fluro.video").filter("trustfluro",["$sce",function($sce){return function(val){return $sce.trustAsResourceUrl(val)}}]),angular.module("fluro.video").controller("FluroVideoController",["$scope",function($scope){}]),angular.module("fluro.video").service("VideoTools",["$http",function($http){var controller={},cache={};return controller.getVideoThumbnail=function(item){if(item&&item._id){if(cache[item._id])return cache[item._id];switch(item.assetType){case"youtube":var details=controller.parseVideoURL(item.external.youtube);cache[item._id]="https://img.youtube.com/vi/"+details.id+"/mqdefault.jpg";break;case"vimeo":controller.getVimeoID(item.external.vimeo);return;case"upload":return}return cache[item._id]}},controller.getVimeoID=function(url){var reg=/https?:\/\/(?:www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/,match=url.match(reg);if(match)return match[3]},controller.parseVideoURL=function(url){function contains(str,substr){return str.indexOf(substr)>-1}function getParm(url,base){var re=new RegExp("(\\?|&)"+base+"\\=([^&]*)(&|$)"),matches=url.match(re);return matches?matches[2]:""}var matches,retVal={};if(url.indexOf("youtube.com/watch")!=-1)retVal.provider="youtube",retVal.id=getParm(url,"v");else if(matches=url.match(/vimeo.com\/(\d+)/))retVal.provider="vimeo",retVal.id=matches[1];else{var youtubeRegexp=/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com\S*[^\w\s-])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,YoutubeID=url.replace(youtubeRegexp,"$1");if(contains(YoutubeID,";")){var pieces=YoutubeID.split(";");if(contains(pieces[1],"%")){var uriComponent=decodeURIComponent(YoutubeID.split(";")[1]);YoutubeID=("http://youtube.com"+uriComponent).replace(youtubeRegexp,"$1")}else YoutubeID=pieces[0]}else contains(YoutubeID,"#")&&(YoutubeID=YoutubeID.split("#")[0]);retVal.provider="youtube",retVal.id=YoutubeID}return retVal},controller}]),angular.module("fluro.video").directive("videoThumbnail",function(){return{restrict:"E",replace:!0,scope:{model:"=ngModel"},template:'<span><img ng-src="{{thumbnailUrl}}"/></span>',controller:["$scope","$http","Fluro","VideoTools",function($scope,$http,Fluro,VideoTools){$scope.$watch("model",function(model){if(model)switch(model){case"vimeo":case"youtube":$scope.thumbnailUrl=Fluro.apiURL+"/get/"+model._id+"/poster"}})}]}}),angular.module("fluro.video").service("VimeoEmbedSettings",["$http",function($http){var controller={};return controller.getVideoInformation=function(vimeoID){return $http.get("http://vimeo.com/api/v2/video/"+vimeoID+".output")},controller}]),angular.module("fluro.video").directive("vimeoVideo",["$compile","VimeoEmbedSettings",function($compile,VimeoEmbedSettings){return{restrict:"E",scope:{videoId:"=",videoUrl:"=",playerVars:"="},link:function($scope,$element,$attrs){function getVimeoID(url){var reg=/https?:\/\/(?:www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|album\/(\d+)\/video\/|)(\d+)(?:$|\/|\?)/,match=url.match(reg);if(match)return match[3]}$scope.getVideoInformation=function(){if($scope.videoId)return VimeoEmbedSettings.getVideoInformation($scope.videoId)},$scope.$watch("videoId + videoUrl + playerVars",function(){var VideoID;$scope.videoId?VideoID=$scope.videoId:$scope.videoUrl&&(VideoID=getVimeoID($scope.videoUrl));var params="";if($scope.playerVars)for(var key in $scope.playerVars)params+="&"+key+"="+$scope.playerVars[key];$scope.vimeoEmbedURL="//player.vimeo.com/video/"+VideoID+"?player_id="+VideoID+params});var template='<iframe ng-src="{{vimeoEmbedURL | trustVimeo}}" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe>',cTemplate=$compile(template)($scope);$element.replaceWith(cTemplate)}}}]),angular.module("fluro.video").filter("trustVimeo",["$sce",function($sce){return function(val){return $sce.trustAsResourceUrl(val)}}]);